---
title: 'Business Statistics Assessment'
author: 1358850 # Put your student number here, not your name
output: 
   html_document:
    toc: true
    toc_depth: 3 
---

# Data Preparation

```{r setup, include=FALSE}
library(tidyverse)
library(emmeans)
library(gridExtra)
library(grid)
options(width=100)
```

```{r, include=FALSE}
#Read the data and check the structure
payday <- read_csv("payday.csv")
glimpse(payday)
```

Data Dictionary      | Description
-------------------- | ------------------------------------------------
id                   | Customer ID
credit.score         | credit score of the customers
loan                 | whether or not people were given the payday loan (dummy variable)
SES                  | customer's socio econmic status, higher score mean higher status
well.being           | self-reported well-being of the customers (1-7 scales), 7 is the highest well-being
adverse.credit.event | whether there was an adverse credit event in the next year (dummy variable)


---

Rename this file and the folder it is in with your student number (e.g., "1912345.Rmd")

Submit this file and the knitted html as a zip file (e.g., 1912345.zip) _by right clicking on the folder to zip it_. That is, the zip file 1912345.zip should contain the folder 1912345 with _only_ the files 1912345.Rmd and 1912345.html

---

# Question 1 Section 1

Plain English answer here!

```{r echo=FALSE, message=FALSE, warning=FALSE}
mean.wellbeing.loan <- payday %>% group_by(loan) %>% summarize(mean.well = mean(well.being))

ggplot(payday, aes(x=loan, y=well.being)) + geom_jitter(width = 0.08, alpha = 0.3, aes(col = factor(loan))) + geom_point(data = mean.wellbeing.loan, aes(x= loan, y = mean.well), shape=4) + geom_smooth(data = payday, mapping = aes(x=loan, y=well.being), method = "lm", se=FALSE, col ="black") + labs(x= "Loan", y="Well being") + guides(col=guide_legend(title="Loan status"))
```

"According to the statistical analysis, the well being of the customers change depending on their loan status. In conclusion, 2.17 extra well being score is expected 95% CI[2.084-2.246] for receiving a loan. This increase is significantly different from zero, $t(4998) = 52.33$, $p<.0001$. The change can be visually recognised in the above figure, as the black line tends to go upper right as loan increases from 0 to 1. In addtion, the dispersion of coloured dots clearly show that customers with no loan (`red dots`) are clusterd more in low well being score, while the customers with loan (`blue dots`) are clusted more in high well being score. If a customer has no loan, the estiated well being score is 2.89 95% CI[2.83-2.95]. If a customer has a loan, the estimated well being score is 5.05 95% CI[5.00-5.11]."


---

# Question 2 Section 1

Plain English answer here!

---

# Question 1 Section 2

## Exploratory Data Analysis

```{r}
#Graphical view of each column data of the data set
grid.arrange(ggplot(payday, aes(x=loan)) + geom_bar(width=0.5),
             ggplot(payday, aes(x=well.being)) + geom_bar(),
             ggplot(payday, aes(x=credit.score)) + geom_bar(),
             ggplot(payday, aes(x=SES)) + geom_bar()
)
```

```{r}
#Brief graphical view of relationships bewteen the well.being column (target column) and the other columns
mean.wellbeing.loan <- payday %>% group_by(loan) %>% summarize(mean.well = mean(well.being))

ggplot(payday, aes(x=loan, y=well.being)) + geom_jitter(width = 0.02, alpha = 0.4, aes(col = factor(loan))) + geom_point(data = mean.wellbeing.loan, aes(x= loan, y = mean.well), shape=4) + geom_smooth(data = payday, mapping = aes(x=loan, y=well.being), method = "lm", se=FALSE, col ="black")

ggplot(payday, aes(x=credit.score, y=well.being)) + geom_jitter() + geom_smooth(method = "lm", se=FALSE)

ggplot(payday, aes(x=SES, y=well.being)) + geom_jitter() + geom_smooth(method = "lm", se=FALSE)
```


## Linear Regression model

### Model 1

$\widehat{wellbeing} = \beta_{Intercept} + \beta_{loan} \times loan$

```{r}
#Making a linear regression model using only loan data
m.wellbeing.by.loan <- lm(well.being ~ loan, data = payday)
summary(m.wellbeing.by.loan)
cbind(coefficient=coef(m.wellbeing.by.loan), confint(m.wellbeing.by.loan))
( m.wellbeing.loan.emm <- summary(emmeans(m.wellbeing.by.loan, ~loan)) )
```

2.17 extra well being score is expected 95% CI[2.084-2.246] for receiving a loan. This increase is significantly different from zero, $t(4998) = 52.33$, $p<.0001$. If a customer has no loan, the estiated well being score is 2.89 95% CI[2.83-2.95]. If a customer has a loan, the estimated well being score is 5.05 95% CI[5.00-5.11]

```{r}
anova(m.wellbeing.by.loan)
```

The result shows that adding loan as an independent variable has a significant effect on predicting the score of well being. Therefore, the well being differs significantly depending on the loan status, F(1,4998) = 2738.6, p<.0001.

### Model 2

$\widehat{wellbeing} = \beta_{Intercept} + \beta_{loan} \times loan + \beta_{credit.score} \times credit.score$

```{r}
#Making linear regression model with credit.score and loan
m.wellbeing.by.credit.loan <- lm(well.being ~ credit.score + loan, data = payday)
summary(m.wellbeing.by.credit.loan)
cbind(coefficient=coef(m.wellbeing.by.credit.loan), confint(m.wellbeing.by.credit.loan))
```

"The well being score is expected to increase by 0.023 95% CI[0.022-0.025] for an extra credit score, holding the loan status without any change. This increase in well being by credit score is significantly different from zero, $t(4997) = 37.217$, $p<.0001$. On the other hand, the well being scroe is expected to decrease by 0.15 95% CI[0.011-0.295], holding the credit.score constant. This decrease in well being by loan status is significantly different from zero, $t(4997) = -2.123$, $p = 0.0338$."

```{r}
anova(m.wellbeing.by.credit.loan)
```

"The result shows that adding credit.score as an independent variable to a model with only an intercept significantly improves the fit of the model, $F(1,4997) = 4877.670$, $p<.0001$. Adding loan to a model with an intercept and credit.score sigficantly improves the fit of the model, $F(1,4997) = 4.506$, $p = 0.03382$."

### Discussion on the model 1 and model 2

In the model 1, loan status is clearly a significant predictor on well being score, $t(4998) = 52.33$, $p<.0001$. There is 2.17 extra well being score 95% CI[2.084-2.246] for having a loan. However, in model 2, loan becomes less significant predictor with high p value, $t(4997) = -2.123$, $p = 0.0338$. Furthermore, the impact on the model is weakened. There is 0.15 decrease in well being 95% CI[0.011-0.295] for having a loan, which is relatively smaller impact than 2.17 increase in well being of the model 1.

```{r}
#Correlation check to assess the multicollinearity between the attributes
round(cor(payday[,c("credit.score", "loan", "SES")]), digits = 1)^2
```

This is mainly because **there is multicollinearity between the loan and credit.score**. As shown in the table, there is a significant positive correlation ($r^2 = 0.81$, $N = 5000$) between $credit.score$ and $loan$. This correlation can be explained by the fact that _'everyone applied for a payday loan, and those with credit scores of 500 or over received the loan'_. That is, the loan status is decided depending on the credit scores. Therefore, $credit.score$ explains the well being better and dilutes the effect of $loan$ as a predictor, when both $loan$ and $credit.score$ are taken into account.

```{r}
#Graphical analysis showing the multicollinearity effect between credit.score an loan

credit.deciles <- quantile(pull(payday, credit.score), seq(0,1,.1))
payday.credit.cut <- payday %>% mutate(credit.cut = cut(credit.score, breaks=credit.deciles, include.lowest=TRUE))
payday.by.credit.cut.loan <- payday.credit.cut %>% group_by(credit.cut,loan) %>% summarise(mean.wellbeing=mean(well.being), mean.credit=mean(credit.score))

m.wellbeing.credit.cut.loan <- lm(well.being ~ credit.cut + loan, data=payday.credit.cut)
( m.wellbeing.credit.cut.loan.emm <- summary(emmeans(m.wellbeing.credit.cut.loan, ~credit.cut + loan)) )

grid.arrange(
	ggplot(payday.credit.cut, aes(y=well.being, x=loan)) + geom_jitter(width = 0.2) + geom_smooth(method = "lm", se=FALSE) + labs(x= "Loan", y="Well being"),
	ggplot(payday.credit.cut, aes(y=well.being, x=loan, col=credit.cut)) + geom_jitter(width = 0.2) + geom_line(data=m.wellbeing.credit.cut.loan.emm, aes(y=emmean, x=loan, col=credit.cut)) + guides(col=guide_legend(title="credit cut")) + labs(x= "Loan", y="Well being"),
	ncol=2 , widths=c(1,1.4), top = "The effect of credit score on loan"
)
```

This graph shows the how the significance of loan changes due to the credit.score. The left plot indicates $model 1$. When $loan$ is the sole independent variable, it is a significant predictor of the $wellbeing$, as shown in the blue regression line. The right plot breaks this down by deciles of $cerdit.score$. It is clear that when $credit.score$ is held constant at any given credit cut, $loan$ has smaller effect on the model with almost horizontal regression line. That is, $loan$ is not a significant predictor anymore when $credit.score$ is also taken into account to model building.

In summary, it is clear that credit.score and loan have multicollinearity. Therefore, only loan should be considered as an independent variable in order to answer the question `Does receiving a payday loan change well-being?` precisely. If credit.score is considered with loan as independant variables, it dominates loan as a predictor and the model result will answer `Does credit score affect well-being?`.

### Discussion on SES

```{r}
m.wellbeing.by.loan.SES <- lm(well.being ~ loan + SES, data = payday)
summary(m.wellbeing.by.loan.SES)
cbind(coefficient=coef(m.wellbeing.by.loan.SES), confint(m.wellbeing.by.loan.SES))
```

"The well being score is expected to increase by 1.511 95% CI[1.445-1.577] for having a $loan$, holding the $SES$ without any change. This increase in well being by $loan$ is significantly different from zero, $t(4997) = 45.02$, $p<.0001$. On the other hand, the well being scroe is expected to increase by 0.375 95% CI[0.362-0.387], holding the $loan$ constant. This increase in well being by $SES$ is significantly different from zero, $t(4997) = 59.31$, $p<.0001$."

According to the result, adding $SES$ as an independent varaible will make the linear regression model better. However, the question is about the relationship between $wellbeing$ and $loan$. Therefore, $SES$ should not be taken into account to answer the question, otherwise it will answer the question about `Does receiving a payday loan and difference in socio economic status change well-being?`.

---

# Question 2 Section 2


```{r}
mean.adverse.loan <- payday %>% group_by(loan) %>% summarize(mean.adverse = mean(adverse.credit.event))

ggplot(payday, aes(x=loan, y=adverse.credit.event, col = factor(loan))) + geom_jitter(alpha = 0.4, width = 0.2, height = 0.2) + geom_point(data = mean.adverse.loan, aes(x=loan, y=mean.adverse, col = factor(loan)), size = 3) + geom_line(data = mean.adverse.loan, aes(x=loan, y=mean.adverse), col = "black")
```


```{r}
m.adverse.by.loan.binom <- glm(adverse.credit.event~loan, family=binomial, data=payday)

m.adverse.by.loan.credit.binom <- glm(adverse.credit.event~ credit.score * loan, family=binomial, data=payday)

m.adverse.by.loan.SES.binom <- glm(adverse.credit.event~ SES * loan, family=binomial, data=payday)

summary(m.adverse.by.loan.binom)
summary(m.adverse.by.loan.credit.binom)
summary(m.adverse.by.loan.SES.binom)

cbind(coef(m.adverse.by.loan.binom),confint(m.adverse.by.loan.binom))

m.adverse.by.loan.binom.emm <- summary(emmeans(m.adverse.by.loan.binom, ~loan, type="response"))
```

```{r}
ggplot(m.adverse.by.loan.binom.emm, aes(x=loan, y=prob, ymin=asymp.LCL, ymax=asymp.UCL)) + 
    geom_ribbon(alpha=0.5) + geom_line() + 
    geom_jitter(data=payday, mapping=aes(y=adverse.credit.event, x=loan, ymin=NULL, ymax=NULL), alpha = 0.4, width = 0.2, height = 0.2) + 
    geom_point(data=mean.adverse.loan, mapping=aes(y=mean.adverse, x=loan, ymin=NULL, ymax=NULL), col="green", size=2) +
    labs(x="Loan", y="Probability of Adverse Credit Event", subtitle="Black dots are individuals who experienced adverse credit event or not.\nGreen dots are the proportion adverse credit event according to loan status.\nThe line and ribbon are the fit of a logistic regression model and its 95% CI") + 
    ylim(0,1)
```


```{r}
Age.deciles <- quantile(titanic$Age, probs=seq(0,1,0.1))
titanic <- titanic %>% mutate(Age.Decile=cut(Age, breaks=Age.deciles, include.lowest=TRUE))
titanic.by.age.sex <- titanic %>% group_by(Age.Decile,Sex) %>% summarise(Proportion.Survived=mean(Survived), decile.mean.age=mean(Age))

ggplot(summary(m.titanic.by.age.sex.binom.emm), aes(x=Age, col=Sex, fill=Sex, y=prob, ymin=asymp.LCL, ymax=asymp.UCL)) + 
    geom_ribbon(alpha=0.5) + geom_line() + 
    geom_jitter(data=titanic, mapping=aes(y=Survived, x=Age, col=Sex, ymin=NULL, ymax=NULL), height=0.04, width=0, alpha=0.5) + 
    geom_point(data=titanic.by.age.sex, mapping=aes(y=Proportion.Survived, x=decile.mean.age, col=Sex, ymin=NULL, ymax=NULL), size=2, shape=3) +
    labs(x="Age / Years", y="Probability of Survival", subtitle="Dots are individuals who survive or die.\n+s are the proportion surviving in each age decile.\nThe line and ribbon are the fit of a logistic regression model and its 95% CI") + 
    ylim(-0.05,1.05)

```





