---
title: 'Business Statistics Assessment'
author: 1358850 # Put your student number here, not your name
output: 
   html_document:
    toc: true
    toc_depth: 3 
---

# Data Preparation

```{r setup, include=FALSE}
library(tidyverse)
library(emmeans)
library(gridExtra)
library(grid)
options(width=100)
```

```{r, include=FALSE}
#Read the data and check the structure
payday <- read_csv("payday.csv")
glimpse(payday)
```

Data Dictionary      | Description
-------------------- | ------------------------------------------------
id                   | Customer ID
credit.score         | credit score of the customers
loan                 | whether or not people were given the payday loan (dummy variable)
SES                  | customer's socio econmic status, higher score mean higher status
well.being           | self-reported well-being of the customers (1-7 scales), 7 is the highest well-being
adverse.credit.event | whether there was an adverse credit event in the next year (dummy variable)


---

Rename this file and the folder it is in with your student number (e.g., "1912345.Rmd")

Submit this file and the knitted html as a zip file (e.g., 1912345.zip) _by right clicking on the folder to zip it_. That is, the zip file 1912345.zip should contain the folder 1912345 with _only_ the files 1912345.Rmd and 1912345.html

---

# Question 1 Section 1

Plain English answer here!

```{r echo=FALSE, message=FALSE, warning=FALSE}
m.wellbeing.by.loan.factor.SES <- lm(well.being ~ loan + SES, data = payday)
m.wellbeing.loan.factor.SES.emm <- summary(emmeans(m.wellbeing.by.loan.factor.SES, ~ loan + SES, at=list(SES=seq(4,26,1))))
wellbeing.by.loan.SES <- payday %>% group_by(SES, loan) %>% summarise(mean.well.being=mean(well.being))

ggplot(m.wellbeing.loan.factor.SES.emm, aes(x=SES, col=factor(loan), fill=factor(loan), y=emmean, ymin=lower.CL, ymax=upper.CL)) + 
    geom_ribbon(alpha=0.2) + geom_line()+ geom_jitter(data=payday, mapping=aes(y=well.being, x=SES, col=factor(loan), ymin=NULL, ymax=NULL), alpha = 0.2, width = 0.3, height = 0.1) + 
    geom_point(data=wellbeing.by.loan.SES, mapping=aes(y=mean.well.being, x=SES, col=factor(loan), ymin=NULL, ymax=NULL), shape=3, size=2) +
    labs(x="SES", y="Well Being", title = "Well Being ", subtitle="Dots are individuals with their own well being score.\n+s are mean well being score according to loan status and socio economic status.\nThe line and ribbon are the fit of a linear regression model and its 95% CI") + guides(col=guide_legend(title="Loan"), fill=guide_legend(title="Loan")) + theme(plot.title = element_text(hjust = 0.5))
```

"According to statistical analysis, well being of customers does change depending on their loan status. The well being score is expected to increase by 1.511 95% CI[1.445-1.577] for having a $loan$, holding the $SES$ constant. This increase in well being by $loan$ is significantly different from zero, $t(4997) = 45.02$, $p<.0001$. In addition, the result of the analysis shows that if a customer with $SES$ of 15 has no $loan$, the estiated well being score is 3.23 95% CI[3.18-3.27]. If a customer with $SES$ of 15 has a $loan$, the estimated well being score is 4.74 95% CI[4.70-4.78]." The above figure helps the understanding of the results with visualisation. Firstly, most of the blue dots are plotted higher than the red dots in any given SES value. This pattern can be recognised more clearly with the line graphs, as the blue line is placed higher than red line across all the SES values. Therefore, it is clear that customers who have loan (blue) are more likely to have higher well being than those who do not (red), regardless of their socio economic status.


---

# Question 2 Section 1

Plain English answer here!


```{r echo=FALSE, message=FALSE, warning=FALSE}
m.adverse.by.loan.SES.binom <- glm(adverse.credit.event ~ loan * SES, family=binomial, data=payday)
m.adverse.by.loan.SES.binom.emm <- summary(emmeans(m.adverse.by.loan.SES.binom, ~loan+SES, at=list(SES=seq(4,26,1)), type="response"))
adverse.by.loan.factor.SES <- payday %>% group_by(SES, loan) %>% summarise(mean.adverse=mean(adverse.credit.event))

ggplot(m.adverse.by.loan.SES.binom.emm, aes(x=SES, col=factor(loan), fill=factor(loan), y=prob, ymin=asymp.LCL, ymax=asymp.UCL)) + 
    geom_ribbon(alpha=0.5) + geom_line()+ geom_jitter(data=payday, mapping=aes(y=adverse.credit.event, x=SES, col=factor(loan), ymin=NULL, ymax=NULL), alpha = 0.2, width = 0.47, height = 0.06) + 
    geom_point(data=adverse.by.loan.factor.SES, mapping=aes(y=mean.adverse, x=SES, col=factor(loan), ymin=NULL, ymax=NULL), shape=3, size=2) +
    labs(x="SES", y="Probability of Adverse Credit Event", subtitle="Dots are individuals who experienced adverse credit event or not.\n+s are the probability of adverse credit event at each socio economic status.\nThe line and ribbon are the fit of a logistic regression model and its 95% CI") + guides(col=guide_legend(title="Loan"), fill=guide_legend(title="Loan")) + theme(plot.title = element_text(hjust = 0.5)) + scale_color_discrete(labels = c("No", "Yes")) + scale_fill_discrete(labels = c("No", "Yes")) + ylim(0,1)
```

This figure shows the relationships between `loan`, `SES` and `adverse.credit.event`. The blue dots are more dominant on the lower part (`experienced no adverse credit event`), while there are relatively more red dots on the upper part (`experienced adverse credit event`). In addition, the blue line is placed relatively lower than the red line. These features mean that people having a loan are less liekly to experience adverse credit event. According to the statistical analysis, this effect of loan on adverse credit event is significant, $z(4998) = -16.080$, $p < .0001$ and $\chi^2(4998)=6644.6$, $p<.0001$. If a customer has no loan, the probability of experienceing adverse credit event is 0.586 95% CI[0.566-0.606]. If a customer has a loan, the probabilty of experiencing averse credit event decreases to 0.357 95% CI[0.339-0.376]. 

Across all the SES values, however, both line graphs maintains a horizontal shape and the $+$ signs randomly fluctuate. That is, it is difficult to find out any pattern or trend on adverse credit event when SES is taken into account. Thus, socio economic status does not have a significant effect on adverse credit event as a predictor, $z(4996) = -0.434$, $p = 0.6646$ and $\chi^2(4997)=6643.7$, $p = 0.3394$. Furthermore, it also implies that the effect of loan on adverse credit event does not differ significantly by SES, $z(4996) = -0.351$, $p = 0.7259$ and $\chi^2(4996) = 6643.6$, $p = 0.7259$. Therefore, considering socio economic status in predicting the likelihood of adverse credit event has no significant meaning.

---

# Question 1 Section 2


```{r echo=FALSE, message=FALSE, warning=FALSE}
mean.wellbeing.loan <- payday %>% group_by(loan) %>% summarize(mean.well = mean(well.being))

ggplot(payday, aes(x=loan, y=well.being)) + geom_jitter(width = 0.08, alpha = 0.3, aes(col = factor(loan))) + geom_point(data = mean.wellbeing.loan, aes(x= loan, y = mean.well), shape=4) + geom_smooth(data = payday, mapping = aes(x=loan, y=well.being), method = "lm", se=FALSE, col ="black") + labs(title ="Relationship between loan and well being", x= "Loan", y="Well being") + guides(col=guide_legend(title="Loan status")) + theme(plot.title = element_text(hjust = 0.5))
```

"According to the statistical analysis, well being of customers change depending on their loan status. In conclusion, 2.17 extra well being score is expected 95% CI[2.084-2.246] for receiving a loan. This increase is significantly different from zero, $t(4998) = 52.33$, $p<.0001$. The change can be visually recognised in the above figure, as the black line tends to go upper right as loan increases from 0 to 1. In addtion, the dispersion of coloured dots clearly show that customers with no loan (`red dots`) are clusterd more in low well being score area, while the customers with loan (`blue dots`) are clusted more in high well being score area. If a customer has no loan, the estiated well being score is 2.89 95% CI[2.83-2.95]. If a customer has a loan, the estimated well being score is 5.05 95% CI[5.00-5.11]."



## Exploratory Data Analysis (EDA)

```{r}
#Graphical view of each column data of the data set
grid.arrange(ggplot(payday, aes(x=loan)) + geom_bar(width=0.5),
             ggplot(payday, aes(x=well.being)) + geom_bar(),
             ggplot(payday, aes(x=credit.score)) + geom_bar(),
             ggplot(payday, aes(x=SES)) + geom_bar()
)
```

```{r}
#Brief graphical view of relationships bewteen the well.being column (target column) and the other columns
mean.wellbeing.loan <- payday %>% group_by(loan) %>% summarize(mean.well = mean(well.being))

ggplot(payday, aes(x=loan, y=well.being)) + geom_jitter(width = 0.02, alpha = 0.4, aes(col = factor(loan))) + geom_point(data = mean.wellbeing.loan, aes(x= loan, y = mean.well), shape=4) + geom_smooth(data = payday, mapping = aes(x=loan, y=well.being), method = "lm", se=FALSE, col ="black")

ggplot(payday, aes(x=credit.score, y=well.being)) + geom_jitter() + geom_smooth(method = "lm", se=FALSE)

ggplot(payday, aes(x=SES, y=well.being)) + geom_jitter() + geom_smooth(method = "lm", se=FALSE)
```


## Linear Regression model

### Model 1

$\widehat{wellbeing} = \beta_{Intercept} + \beta_{loan} \times loan$

```{r}
#Making a linear regression model using only loan data
m.wellbeing.by.loan <- lm(well.being ~ loan, data = payday)
summary(m.wellbeing.by.loan)
cbind(coefficient=coef(m.wellbeing.by.loan), confint(m.wellbeing.by.loan))
( m.wellbeing.loan.emm <- summary(emmeans(m.wellbeing.by.loan, ~loan)) )
```

"2.17 extra well being score is expected 95% CI[2.084-2.246] for receiving a loan. This increase is significantly different from zero, $t(4998) = 52.33$, $p<.0001$. If a customer has no loan, the estiated well being score is 2.89 95% CI[2.83-2.95]. If a customer has a loan, the estimated well being score is 5.05 95% CI[5.00-5.11]"

```{r}
anova(m.wellbeing.by.loan)
```

"The anova result shows that adding loan as an independent variable has a significant effect on predicting the score of well being. Therefore, the well being differs significantly depending on the loan status, F(1,4998) = 2738.6, p<.0001."

### Model 2

$\widehat{wellbeing} = \beta_{Intercept} + \beta_{loan} \times loan + \beta_{credit.score} \times credit.score$

```{r}
#Making linear regression model with credit.score and loan
m.wellbeing.by.credit.loan <- lm(well.being ~ credit.score + loan, data = payday)
summary(m.wellbeing.by.credit.loan)
cbind(coefficient=coef(m.wellbeing.by.credit.loan), confint(m.wellbeing.by.credit.loan))
```

"The well being score is expected to increase by 0.023 95% CI[0.022-0.025] for an extra credit score, holding the loan status without any change. This increase in well being by credit score is significantly different from zero, $t(4997) = 37.217$, $p<.0001$. On the other hand, the well being scroe is expected to decrease by 0.15 95% CI[0.011-0.295], holding the credit.score constant. This decrease in well being by loan status is significantly different from zero, $t(4997) = -2.123$, $p = 0.0338$."

```{r}
anova(m.wellbeing.by.credit.loan)
```

"The anova result shows that adding credit.score as an independent variable to a model with only an intercept significantly improves the fit of the model, $F(1,4997) = 4877.670$, $p<.0001$. Adding loan to a model with an intercept and credit.score also improves the fit of the model, $F(1,4997) = 4.506$, $p = 0.03382$."

### Discussion on the model 1 and model 2

In the model 1, loan status is clearly a significant predictor on well being score, $t(4998) = 52.33$, $p<.0001$. There is 2.17 extra well being score 95% CI[2.084-2.246] for having a loan. However, in the model 2, loan becomes less significant predictor with relatively high p value, $t(4997) = -2.123$, $p = 0.0338$. Furthermore, the impact on the model has been weakened. There is 0.15 decrease in well being 95% CI[0.011-0.295] for having a loan, which is relatively smaller impact than 2.17 increase in well being of the model 1. The 0.15 decrease of well being by having a loan also does not correspond to the result of EDA and model 1.

```{r}
#Correlation check to assess the multicollinearity between the attributes
round(cor(payday[,c("credit.score", "loan", "SES")]), digits = 1)^2
```

This is mainly because **there is multicollinearity between the loan and credit.score**. As shown in the table, there is a significant positive correlation ($r^2 = 0.81$, $N = 5000$) between $credit.score$ and $loan$. This correlation can be explained by the fact that _'everyone applied for a payday loan, and those with credit scores of 500 or over received the loan'_. The loan status is decided depending on the credit scores. Therefore, $credit.score$ explains well being much better and dilutes the effect of $loan$ as a predictor, when both $loan$ and $credit.score$ are taken into account.

```{r}
#Graphical analysis showing the multicollinearity effect between credit.score an loan

#making deciles for credit.score column and make new linear model with credit cut and loan
credit.deciles <- quantile(pull(payday, credit.score), seq(0,1,.1))
payday.credit.cut <- payday %>% mutate(credit.cut = cut(credit.score, breaks=credit.deciles, include.lowest=TRUE))
m.wellbeing.credit.cut.loan <- lm(well.being ~ credit.cut + loan, data=payday.credit.cut)
m.wellbeing.credit.cut.loan.emm <- summary(emmeans(m.wellbeing.credit.cut.loan, ~credit.cut + loan))

#utilise above information to visualise the impact of credit.score on loan when predicting well being
grid.arrange(
	ggplot(payday.credit.cut, aes(y=well.being, x=loan)) + geom_jitter(width = 0.2) + geom_smooth(method = "lm", se=FALSE) + labs(x= "Loan", y="Well being"),
	ggplot(payday.credit.cut, aes(y=well.being, x=loan, col=credit.cut)) + geom_jitter(width = 0.2) + geom_line(data=m.wellbeing.credit.cut.loan.emm, aes(y=emmean, x=loan, col=credit.cut)) + guides(col=guide_legend(title="credit cut")) + labs(x= "Loan", y="Well being"),
	ncol=2 , widths=c(1,1.4), top = "The effect of credit score on loan"
)
```

This graph shows the how the significance of loan changes due to the credit.score. The left plot indicates $model 1$. When $loan$ is the sole independent variable, it is a significant predictor of the $wellbeing$, as shown in the blue regression line. The right plot breaks this down by deciles of $cerdit.score$. It is clear that when $credit.score$ is held constant at any given credit cut, $loan$ has smaller effect on the model with almost horizontal regression lines. That is, $loan$ is not a significant predictor anymore when $credit.score$ is also taken into account to model building.

It is obvious that $credit.score$ and $loan$ have multicollinearity. Therefore, it is better to consider loan as an only independent variable in order to answer the question `Does receiving a payday loan change well-being?` more precisely. If $credit.score$ is considered with $loan$ as independant variables, it dominates loan as a predictor and the model result is more likely to be an answer for the question `How does credit score affect well-being of customers?`.

### Discussion on SES

```{r}
m.wellbeing.by.loan.factor.SES <- lm(well.being ~ loan + factor(SES), data = payday)
( m.wellbeing.loan.factor.SES.emm <- summary(emmeans(m.wellbeing.by.loan.factor.SES, ~ SES + loan)) )

grid.arrange(
	ggplot(payday, aes(y=well.being, x=loan)) + geom_jitter(width = 0.2) + geom_smooth(method = "lm", se=FALSE) + labs(x= "Loan", y="Well being"),
	ggplot(payday, aes(y=well.being, x=loan, col=factor(SES))) + geom_jitter(width = 0.2) + geom_line(data=m.wellbeing.loan.factor.SES.emm, aes(y=emmean, x=loan, col=factor(SES))) + guides(col=guide_legend(title="SES")) + labs(x= "Loan", y="Well being"),
	ncol=2 , widths=c(1,1.4), top = "The effect of SES on loan"
)
```

According to correlation matrix discussed above, $SES$ has significantly low level of correlation ($r^2 = 0.81$, $N = 5000$) with $loan$. Therefore, $SES$ can also become a significant predictor on well being while it hardly affects the significance of $loan$. According to the above figure, the regression lines on both left (blue) and right (various colours) plots have almost same slope. It cleary shows that $loan$ still maintains its significance as a predictor when $SES$ is added as an independent variable and held constant at any given value, unlike the previous case of $credit.score$ and $loan$. Both $loan$ and $SES$ can be used into the linear model in order to find out more precise impact (coefficient) of the $loan$ on well being. Having two attributes into the model (model 3) can better reflect the real world of data than that with only one attribute (model 1). Then, the impact of $loan$ on well being will indicate more realistic figure.

### Final model

```{r}
m.wellbeing.by.loan.SES.interaction <- lm(well.being ~ loan * SES, data = payday)
summary(m.wellbeing.by.loan.SES)
```

The ineteraction $loan:SES$ is not needed, as the increase of 0.008 by an extra $loan:SES$ is not significantly different from zero, so that $loan$ does not differ significantly depending on the $SES$, $t(4996) = 0.615$, $p = 0.538$. Therefore, the final model should be as follows:

$\widehat{wellbeing} = \beta_{Intercept} + \beta_{loan} \times loan + \beta_{SES} \times SES$

```{r}
m.wellbeing.by.loan.SES <- lm(well.being ~ loan + SES, data = payday)
summary(m.wellbeing.by.loan.SES)
cbind(coefficient=coef(m.wellbeing.by.loan.SES), confint(m.wellbeing.by.loan.SES))
( m.wellbeing.by.loan.SES.emm <- summary(emmeans(m.wellbeing.by.loan.SES, ~ SES + loan)) )
```

"The well being score is expected to increase by 1.511 95% CI[1.445-1.577] for having a $loan$, holding the $SES$ without any change. This increase in well being by $loan$ is significantly different from zero, $t(4997) = 45.02$, $p<.0001$. On the other hand, the well being scroe is expected to increase by 0.375 95% CI[0.362-0.387] for an extra $SES$, holding the $loan$ constant. This increase in well being by $SES$ is significantly different from zero, $t(4997) = 59.31$, $p<.0001$. If a customer with $SES$ of 15 has no $loan$, the estiated well being score is 3.23 95% CI[3.18-3.27]. If a customer with $SES$ of 15 has a loan , the estimated well being score is 4.74 95% CI[4.70-4.78]."

---

# Question 2 Section 2

## Exploratory Data Analysis (EDA)

```{r}
mean.adverse.loan <- payday %>% group_by(loan) %>% summarize(mean.adverse = mean(adverse.credit.event))

ggplot(payday, aes(x=loan, y=adverse.credit.event, col = factor(loan))) + geom_jitter(alpha = 0.4, width = 0.2, height = 0.2) + geom_point(data = mean.adverse.loan, aes(x=loan, y=mean.adverse, col = factor(loan)), size = 3) + geom_line(data = mean.adverse.loan, aes(x=loan, y=mean.adverse), col = "black")
```

It is expected that having a loan decreases adverse credit events.

## Logistic Regrssion Model

Adverse credit event is a binary variable (dummy variable). Therefore, logistic regression can be used to find out the model of the best fit.

### Discussion on SES

```{r}
m.adverse.by.loan.SES.binom <- glm(adverse.credit.event ~ loan * SES, family=binomial, data=payday)
summary(m.adverse.by.loan.SES.binom)
anova(m.adverse.by.loan.SES.binom, test="Chisq")
```

The changes in log odds of adverse credit event due to $SES$ and $loan:SES$ are not significantly different from zero, $z(4996) = -0.434$, $p = 0.6646$ and $z(4996) = -0.351$, $p = 0.7259$. Anova result also shows that adding $SES$ and $loan:SES$ makes the model worse in the presence of loan and the effect of loan does not differ by SES, $\chi^2(4997)=6643.7$, $p = 0.3394$ and $\chi^2(4996) = 6643.6$, $p = 0.7259$. Only loan seems to have a significant impact on the log odds of adverse credit event, $z(4996) = -2.250$, $p = 0.0245$ and $\chi^2(4998) = 6644.6$, $p<.0001$. Therefore, it is better to build model with only loan to answer the question precisely, as SES has no significant effect on either adverse credit event and loan. 

### Final model

$\log(\frac{p}{1-p})= \beta_0 + \beta_{loan} loan$

```{r}
m.adverse.by.loan.binom <- glm(adverse.credit.event ~ loan, family=binomial, data=payday)
summary(m.adverse.by.loan.binom)
cbind(coef(m.adverse.by.loan.binom),confint(m.adverse.by.loan.binom))
anova(m.adverse.by.loan.binom, test="Chisq")
( m.adverse.by.loan.binom.emm <- summary(emmeans(m.adverse.by.loan.binom, ~loan, type="response")) )
```

"The log odds ($\log(\frac{p}{1-p})$) of adverse credit event decreases by 0.937 95% CI[0.823-1.051] for having a loan. This decrease effect by having a loan is significant, $z(4998) = -16.080$, $p < .0001$ and $\chi^2(4998)=6644.6$, $p<.0001$. The relationship of loan and adverse credit event can be explained in a probabilistic way. If a customer has no loan, the probability of adverse credit event ($p$) is 0.586 95% CI[0.566-0.606]. If a customer has a loan, the probabilty of averse credit event decreases to 0.357 95% CI[0.339-0.376]."


