---
title: 'Business Statistics Assessment'
author: 1358850 # Put your student number here, not your name
output: 
   html_document:
    toc: true
    toc_depth: 3 
---

#Data Preparation

```{r setup, include=FALSE}
library(tidyverse)
library(emmeans)
library(gridExtra)
library(grid)
options(width=100)
```

```{r, include=FALSE}
payday <- read_csv("payday.csv")
glimpse(payday)
```

Data Dictionary      | Description
-------------------- | ------------------------------------------------
id                   | Customer ID
credit.score         | credit score of the customers
loan                 | whether or not people were given the payday loan (dummy variable)
SES                  | customer's socio econmic status, higher score mean higher status
well.being           | self-reported well-being of the customers (1-7 scales), 7 is the highest well-being
adverse.credit.event | whether there was an adverse credit event in the next year (dummy variable)


---

Rename this file and the folder it is in with your student number (e.g., "1912345.Rmd")

Submit this file and the knitted html as a zip file (e.g., 1912345.zip) _by right clicking on the folder to zip it_. That is, the zip file 1912345.zip should contain the folder 1912345 with _only_ the files 1912345.Rmd and 1912345.html

---

# Question 1 Section 1

Plain English answer here!

$\widehat{wellbeing} = \beta_{Intercept} + \beta_{loan} \times Assault + \beta_{creditscore} \times creditscore + \beta_{SES} \times SES$


---

# Question 2 Section 1

Plain English answer here!

---

# Question 1 Section 2

```{r}
grid.arrange(ggplot(payday, aes(x=loan)) + geom_bar(width=0.5),
             ggplot(payday, aes(x=well.being)) + geom_bar(),
             ggplot(payday, aes(x=credit.score)) + geom_bar(),
             ggplot(payday, aes(x=SES)) + geom_bar()
)
```

```{r}
mean.wellbeing.loan <- payday %>% group_by(loan) %>% summarize(mean.well = mean(well.being))

ggplot(payday, aes(x=loan, y=well.being)) + geom_jitter(width = 0.02, alpha = 0.4, aes(col = factor(loan))) + geom_hline(data = mean.wellbeing.loan, aes(yintercept = mean.well, col = factor(loan))) + geom_smooth(data = payday, mapping = aes(x=loan, y=well.being), method = "lm", se=FALSE, col ="black")

ggplot(payday, aes(x=credit.score, y=well.being)) + geom_jitter() + geom_smooth(method = "lm", se=FALSE)

ggplot(payday, aes(x=SES, y=well.being)) + geom_jitter() + geom_smooth(method = "lm", se=FALSE)
```



```{r}
m.wellbeing.loan <- lm(well.being ~ loan, data = payday)
m.wellbeing.credit <- lm(well.being ~ credit.score, data = payday)
m.wellbeing.loan.credit <- lm(well.being ~ loan + credit.score, data = payday)
m.wellbeing.loan.credit.combo <- lm(well.being ~ loan * credit.score, data = payday)
m.wellbeing.loan.credit.SES <- lm(well.being ~ loan + credit.score + SES, data = payday)
m.wellbeing.loan.SES <- lm(well.being ~ loan + SES, data = payday)
m.wellbeing.loan.SES.combo <- lm(well.being ~ loan * SES, data = payday)

summary(m.wellbeing.loan)
summary(m.wellbeing.loan.credit)

summary(m.wellbeing.credit)
summary(m.wellbeing.loan.credit)
summary(m.wellbeing.loan.credit.SES)
summary(m.wellbeing.loan.SES)

summary(m.wellbeing.loan.credit.combo)
summary(m.wellbeing.loan.SES.combo)

#the product of SES and loan is not significant impact on the prediction -> MEANINGLESS!

```

```{r}
cbind(coefficient=coef(m.wellbeing.loan), confint(m.wellbeing.loan))
cbind(coefficient=coef(m.wellbeing.credit), confint(m.wellbeing.credit))
cbind(coefficient=coef(m.wellbeing.loan.credit), confint(m.wellbeing.loan.credit))
cbind(coefficient=coef(m.wellbeing.loan.SES), confint(m.wellbeing.loan.SES))
cbind(coefficient=coef(m.wellbeing.loan.SES.combo), confint(m.wellbeing.loan.SES.combo))

m.wellbeing.loan.emm <- summary(emmeans(m.wellbeing.loan, ~loan))
m.wellbeing.credit.emm <- summary(emmeans(m.wellbeing.credit, ~credit.score))
m.wellbeing.loan.credit.emm <- summary(emmeans(m.wellbeing.loan.credit, ~ credit.score + loan))
m.wellbeing.loan.SES.emm <- summary(emmeans(m.wellbeing.loan.SES, ~ SES + loan))
#loan emmean (0 = 2.89 / 1 = 5.05) VS loan.credit emmean (0 = 4.09 / 1 = 3.94)
#loan.credit model is wrong due to the multicollinearity
#loan.SES model explains OK? (0 = 3.23 / 1 = 4.74)

anova(m.wellbeing.loan)
anova(m.wellbeing.credit)
anova(m.wellbeing.loan.credit)
anova(m.wellbeing.loan.SES)
anova(m.wellbeing.loan.credit.SES)
anova(m.wellbeing.loan.SES.combo)

drop1(m.wellbeing.loan.credit, test="F")
```

SES does not differ depends on the loan -> the product variable is useless!

```{r}
round(cor(payday[,c("credit.score", "loan", "SES")]), digits = 1)^2

#there is strong positive correlation (r2 = 0.81) between credit.score and loan -> becuz ppl who have credit of 500 or over received loan
```

```{r}
#graph showing the effect of credit.score on loan
credit.deciles <- quantile(pull(payday, credit.score), seq(0,1,.1))
payday.creditcut <- payday %>% mutate(credit.cut = cut(credit.score, breaks=credit.deciles, include.lowest=TRUE))
payday.by.credit.cut.loan <- payday.creditcut %>% group_by(credit.cut,loan) %>% summarise(mean.wellbeing=mean(well.being), mean.credit=mean(credit.score))

m.wellbeing.loan.credit.cut <- lm(well.being ~ credit.cut + loan, data=payday.creditcut)
m.wellbeing.loan.credit.cut.emm <- summary(emmeans(m.wellbeing.loan.credit.cut, ~credit.cut + loan))

grid.arrange(
	ggplot(payday.creditcut, aes(y=well.being, x=loan)) + geom_jitter(width = 0.2) + geom_smooth(method = "lm", se=FALSE) + labs(x= "Loan", y="Well being"),
	ggplot(payday.creditcut, aes(y=well.being, x=loan, col=credit.cut)) + geom_jitter(width = 0.2) + geom_line(data=m.wellbeing.loan.credit.cut.emm, aes(y=emmean, x=loan, col=credit.cut)) + guides(col=guide_legend(title="credit cut")) + labs(x= "Loan", y="Well being"),
	ncol=2 , widths=c(1,1.4), top = "The effect of credit score on loan"
)
```

The left plot shows $wellbeing$ score as a function of $loan$. When $loan$ is the only independent variable, it is a significant predictor of the $wellbeing$. The right plot breaks this down by deciles of $cerdit$ score. It is clear that when $credit$ score is held constant at any given decile, $loan$ has a much smaller effect. That is, $loan$ is not a significant predictor when $credit$ is also taken into account to the prediction. This is because there is a strong positive correlation between the $credit$ score and $loan$. This is mainly because of the condition that people who applied a loan could receive the loan when they have a credit of 500 or larger. As a result, as shown in the right plot, all $credit$ cut dots of over 500 plotted right hand side ($loan$ = 1), and the dots of less than 500 are all plotted on the left hand side ($loan$ = 0).

That is, credit score dilutes the prediction power of loan. No need to include. These two actually implies similar prediction meaning on the wellbeing (`credit score > 500` == `loan = 1`). But for the question, only loan should be the independent varaible.

```{r}
#graph showing the effect of SES on loan
credit.deciles <- quantile(pull(payday, credit.score), seq(0,1,.1))
payday.creditcut <- payday %>% mutate(credit.cut = cut(credit.score, breaks=credit.deciles, include.lowest=TRUE))

m.wellbeing.loan.SES.factor <- lm(well.being ~ factor(SES) + loan, data=payday.creditcut)
m.wellbeing.loan.SES.factor.emm <- summary(emmeans(m.wellbeing.loan.SES.factor, ~ factor(SES) + loan))

grid.arrange(
	ggplot(payday, aes(y=well.being, x=loan)) + geom_jitter(width = 0.2) + geom_smooth(method = "lm", se=FALSE) + labs(x= "Loan", y="Well being"),
	ggplot(payday, aes(y=well.being, x=loan, col=factor(SES))) + geom_jitter(width = 0.2) + geom_line(data=m.wellbeing.loan.SES.factor.emm, aes(y=emmean, x=loan, col=factor(SES))) + guides(col=guide_legend(title="Socio Economic Status")) + labs(x= "Loan", y="Well being"),
	ncol=2 , widths=c(1,1.7), top = "The effect of SES on loan"
)
```

The left plot shows $wellbeing$ score as a function of $loan$. The right plot grouped this by $SES$. Unlike the previous case of $loan$ and $credit$ score, when $SES$ is held constant at any given level, $loan$ still has significant predictive power.

That is, `SES` has no impacts on the prediction power of loan. Therefore, setting `SES` as an independent varaible will make linear regression model better. However, the question is about the relationship between `wellbeing` and `loan`. Therefore, `SES` should not be taken into account to answer the question, otherwise it will answer the question about `Does receiving a payday loan and difference in socio economic status change well-being?`.   


---

# Question 2 Section 2


```{r}
mean.adverse.loan <- payday %>% group_by(loan) %>% summarize(mean.adverse = mean(adverse.credit.event))

ggplot(payday, aes(x=loan, y=adverse.credit.event, col = factor(loan))) + geom_jitter(alpha = 0.4, width = 0.2, height = 0.2) + geom_point(data = mean.adverse.loan, aes(x=loan, y=mean.adverse, col = factor(loan))) + geom_line(data = mean.adverse.loan, aes(x=loan, y=mean.adverse), col = "black")
```


```{r}
m.adverse.by.loan.binom <- glm(adverse.credit.event~loan, family=binomial, data=payday)

m.adverse.by.loan.credit.binom <- glm(adverse.credit.event~ credit.score * loan, family=binomial, data=payday)

m.adverse.by.loan.SES.binom <- glm(adverse.credit.event~ SES * loan, family=binomial, data=payday)

summary(m.adverse.by.loan.binom)
summary(m.adverse.by.loan.credit.binom)
summary(m.adverse.by.loan.SES.binom)

cbind(coef(m.adverse.by.loan.binom),confint(m.adverse.by.loan.binom))

m.adverse.by.loan.binom.emm <- summary(emmeans(m.adverse.by.loan.binom, ~loan, type="response"))
```

```{r}
ggplot(m.adverse.by.loan.binom.emm, aes(x=loan, y=prob, ymin=asymp.LCL, ymax=asymp.UCL)) + 
    geom_ribbon(alpha=0.5) + geom_line() + 
    geom_jitter(data=payday, mapping=aes(y=adverse.credit.event, x=loan, ymin=NULL, ymax=NULL), alpha = 0.4, width = 0.2, height = 0.2) + 
    geom_point(data=mean.adverse.loan, mapping=aes(y=mean.adverse, x=loan, ymin=NULL, ymax=NULL), col="green", size=2) +
    labs(x="Loan", y="Probability of Adverse Credit Event", subtitle="Black dots are individuals who experienced adverse credit event or not.\nGreen dots are the proportion adverse credit event according to loan status.\nThe line and ribbon are the fit of a logistic regression model and its 95% CI") + 
    ylim(0,1)
```


```{r}
Age.deciles <- quantile(titanic$Age, probs=seq(0,1,0.1))
titanic <- titanic %>% mutate(Age.Decile=cut(Age, breaks=Age.deciles, include.lowest=TRUE))
titanic.by.age.sex <- titanic %>% group_by(Age.Decile,Sex) %>% summarise(Proportion.Survived=mean(Survived), decile.mean.age=mean(Age))

ggplot(summary(m.titanic.by.age.sex.binom.emm), aes(x=Age, col=Sex, fill=Sex, y=prob, ymin=asymp.LCL, ymax=asymp.UCL)) + 
    geom_ribbon(alpha=0.5) + geom_line() + 
    geom_jitter(data=titanic, mapping=aes(y=Survived, x=Age, col=Sex, ymin=NULL, ymax=NULL), height=0.04, width=0, alpha=0.5) + 
    geom_point(data=titanic.by.age.sex, mapping=aes(y=Proportion.Survived, x=decile.mean.age, col=Sex, ymin=NULL, ymax=NULL), size=2, shape=3) +
    labs(x="Age / Years", y="Probability of Survival", subtitle="Dots are individuals who survive or die.\n+s are the proportion surviving in each age decile.\nThe line and ribbon are the fit of a logistic regression model and its 95% CI") + 
    ylim(-0.05,1.05)

```





